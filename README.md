<!-- @format -->

# 杂草盖度与密度估计

## 安装依赖

```bash
python -m pip install -r requirements.txt
```

## 使用方法

### 1. 校准图像

首先，使用校准工具选择图像中代表 1 平方米区域的四个角点：

```bash
python calibration_tool.py
```

操作说明：

- 按顺序点击图像中代表 1 平方米区域的四个角点
- 按 'r' 重置选择
- 按 's' 保存校准点
- 按 'q' 或 ESC 退出

校准点将保存到 `calibration_[图像名].json` 文件中。

### 2. 分析单张图像

```bash
python main.py --image [图像路径] --method [hsv/kmeans] --model [traditional/dl]
```

参数说明：

- `--image`：要分析的图像路径（可选，默认使用数据集中的第一张图像）
- `--calibrate`：添加此参数以在分析前进行校准
- `--method`：传统分割方法，可选 'hsv'（默认）或 'kmeans'
- `--model`：分析模型，可选 'traditional'（传统方法，默认）或 'dl'（深度学习方法）
- `--analyze-lidar`：添加此参数以分析匹配的激光雷达点云数据（如果存在）
- `--dbscan-eps`：DBSCAN 聚类的邻域半径参数（默认 0.05）
- `--dbscan-min-samples`：DBSCAN 聚类的最小样本数参数（默认 3）

### 3. 分析所有图像

```bash
python main.py --all --model [traditional/dl]
```

### 4. 点云数据分析

```bash
python main.py --image [图像路径] --analyze-lidar
```

点云数据分析需要与图像同名的.txt 文件，例如：

- 图像：`datasets/ds3/01.jpeg`
- 点云：`datasets/ds3/01.txt`

## 结果说明

估计结果将保存在 `results` 目录下，包含以下内容：

- 校准后的图像
- 草的分割掩码
- 草的盖度可视化（带百分比）
- 草的密度可视化（带每平方米草的数量）
- 点云分析结果（如果启用）：包含草高估计和 3D 可视化

## 技术说明

### 传统方法

1. **图像校准**：使用透视变换将选定的四边形区域转换为标准的 500x500 像素正方形，代表 1 平方米区域。

2. **草的分割**：

   - HSV 方法：基于 **HSV** 颜色空间的阈值分割，适用于草与背景颜色对比明显的情况
   - K-means 方法：基于颜色聚类的分割，适用于更复杂的场景

3. **盖度计算**：草的像素数 / 总区域像素数 × 100%

4. **密度计算**：使用**分水岭算法**进行实例分割，计算草的实例数量

### 深度学习方法

1. **图像校准**：与传统方法相同，使用透视变换。

2. **草的分割**：

   - 使用预训练的 DeepLabV3 ResNet50 模型进行语义分割
   - 结合多种颜色空间（HSV、LAB）和 K-means 聚类进行增强分割
   - 自适应参数调整：根据图像特性自动调整分割参数
   - 多模型集成：结合深度学习预测和颜色特征

3. **盖度计算**：与传统方法相同，基于分割掩码计算。

4. **密度计算**：
   - 使用连通组件分析估计草的数量
   - 对于复杂场景，使用距离变换和局部极大值检测进行增强估计
   - 自动过滤小区域，提高密度估计准确性
5. **自适应机制**：
   - 自动检测过度分割，并应用更严格的分割条件
   - 根据图像特性自动调整 HSV 阈值和其他参数
   - 多种备用策略，确保在各种场景下都能得到合理结果

### 点云分析方法

1. **数据预处理**：

   - 读取激光雷达点云数据（.txt 格式）
   - 过滤无效数据点（1600.x 类型的值）
   - 将一维距离数据转换为三维点云

2. **地面与植被分离**：

   - 使用 DBSCAN 聚类算法基于高度信息分离地面点和植被点
   - 直接使用 GrassAnalyzer 的 HSV 分割结果辅助分类，确保分类结果与图像分析一致
   - 假设最大聚类为地面点，其余为植被点

3. **草高计算**：

   - 地面高度：地面点的平均高度
   - 植被最大高度：植被点中的最小距离值（因为距离越小，物体越高）
   - 草高 = 地面高度 - 植被最大高度

4. **可视化**：
   - 3D 点云可视化，地面点和植被点使用不同颜色
   - 点云俯视图，直观展示点云分布
   - 图像与点云叠加图，显示点云在图像上的分布
   - HSV 分割结果与点云叠加图，展示分类效果

## 注意事项

1. 深度学习方法需要安装 PyTorch 和 torchvision，首次运行时会自动下载预训练模型。

2. 如果系统没有 GPU，深度学习方法会在 CPU 上运行，可能会比较慢。

3. 为获得最佳结果，建议在校准时选择清晰可见的 1 平方米区域。

4. 调试图像会自动保存在结果目录中，可用于分析分割过程的各个步骤。

5. 点云分析需要与图像同名的.txt 文件，且格式必须符合要求（每行包含逗号分隔的距离值）。
